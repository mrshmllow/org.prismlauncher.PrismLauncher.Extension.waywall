id: org.prismlauncher.PrismLauncher.Extension.waywall
runtime: org.prismlauncher.PrismLauncher
runtime-version: 'test'
branch: test
sdk: org.kde.Sdk//6.10
build-extension: true

build-options:
  prefix: /app/extension/waywall
  prepend-path: /app/extension/waywall/bin
  prepend-pkg-config-path: /app/extension/waywall/lib/pkgconfig
  prepend-ld-library-path: /app/extension/waywall/lib
  env:
    PKG_CONFIG_PATH: /app/extension/waywall/share/pkgconfig

modules:
  # xwayland dep
  - name: libfontenc
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/lib/libfontenc-1.1.9.tar.xz
        sha256: 9d8392705cb10803d5fe1d27d236cbab3f664e26841ce01916bbbe430cf273e2
    cleanup:
      - /include

  # xwayland dep
  - name: libxcvt
    buildsystem: meson
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/lib/libxcvt-0.1.3.tar.xz
        sha256: a929998a8767de7dfa36d6da4751cdbeef34ed630714f2f4a767b351f2442e01
    cleanup:
      - /share/man
      - /include

  # xwayland dep
  - name: libxfont2
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/lib/libXfont2-2.0.7.tar.xz
        sha256: 8b7b82fdeba48769b69433e8e3fbb984a5f6bf368b0d5f47abeec49de3e58efb
    cleanup:
      - /include

  # waywall dep
  - name: xwayland
    buildsystem: meson
    config-opts:
      - -Dxwayland=true
      - -Dxorg=false
      - -Ddocs=false
      - -Ddevel-docs=false
      - -Dxnest=false
      - -Dxephyr=false
      - -Dxvfb=false
      - -Dlibunwind=false
      - -Dglx=true
      - -Dglamor=true
      - -Dxcsecurity=true
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/xserver.git
        branch: main
    cleanup:
      - /share/man
      - /share/applications
      - /share/pkgconfig

  # waywall dep
  - name: luajit
    no-autogen: true
    make-args:
      - PREFIX=/app/extension/waywall
    make-install-args:
      - PREFIX=/app/extension/waywall
    sources:
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        tag: v2.1
    cleanup:
      - /share/man
      - /include

  # waywall runtime dep
  - name: xprop
    config-opts:
      - PREFIX=/app/extension/waywall
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/app/xprop-1.2.8.tar.xz
        sha256: d689e2adb7ef7b439f6469b51cda8a7daefc83243854c2a3b8f84d0f029d67ee
    cleanup:
      - /share/man

  # waywall dep
  - name: spng
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/randy408/libspng/archive/refs/tags/v0.7.4.tar.gz
        sha256: 47ec02be6c0a6323044600a9221b049f63e1953faf816903e7383d4dc4234487
    cleanup:
      - /include

  # glfw
  - name: glfw
    buildsystem: cmake
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DGLFW_BUILD_WAYLAND=ON
    sources:
      - type: git
        url: https://github.com/glfw/glfw
        tag: "3.4"
      - type: patch
        path: glfw.patch
    cleanup:
      - /share/man
      - /share/doc
      - /lib/cmake
      - /include

  - name: waywall
    buildsystem: meson
    post-install:
      - install -D waywall/waywall ${FLATPAK_DEST}/bin/.waywall-unwrapped
    sources:
      - type: git
        url: https://github.com/tesselslate/waywall.git
        branch: main
      - type: patch
        path: 0001-add-info-log-for-flatpak-sandbox-for-wayland-0.patch

  - name: enhance
    buildsystem: simple
    build-commands:
      - install -Dm755 waywall ${FLATPAK_DEST}/bin/waywall
      - chmod +x ${FLATPAK_DEST}/bin/waywall
    sources:
      - type: file
        path: waywall
